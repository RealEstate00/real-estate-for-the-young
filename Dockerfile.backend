# 백엔드 Dockerfile - 윈도우 환경 최적화 및 멀티플랫폼 지원
# 멀티플랫폼 빌드를 위한 베이스 이미지 (AMD64, ARM64 모두 지원)
FROM --platform=$BUILDPLATFORM python:3.12-slim AS builder

# 빌드 인수 설정 (멀티플랫폼 지원)
ARG TARGETPLATFORM
ARG BUILDPLATFORM
ARG TARGETOS
ARG TARGETARCH

# 작업 디렉토리 설정
WORKDIR /app

# 환경 변수 설정 (윈도우 호환성 개선)
ENV PYTHONPATH=/app
ENV PYTHONUNBUFFERED=1
ENV PYTHONDONTWRITEBYTECODE=1
ENV PIP_NO_CACHE_DIR=1
ENV PIP_DISABLE_PIP_VERSION_CHECK=1

# 시스템 의존성 설치 (윈도우 Docker Desktop 환경 최적화)
RUN apt-get update && apt-get install -y \
    gcc \
    g++ \
    curl \
    wget \
    postgresql-client \
    build-essential \
    libpq-dev \
    && rm -rf /var/lib/apt/lists/* \
    && apt-get clean

# 프로젝트 파일 복사 (의존성 먼저 복사하여 캐시 활용)
COPY pyproject.toml ./
COPY uv.lock* ./

# Python 의존성 설치 (윈도우 환경에서 더 안정적)
RUN pip install --no-cache-dir --upgrade pip setuptools wheel && \
    if [ -f uv.lock ]; then \
        pip install --no-cache-dir uv && \
        uv pip install --system -r pyproject.toml; \
    else \
        pip install --no-cache-dir -e .; \
    fi

# 최종 스테이지 (멀티플랫폼 타겟)
FROM python:3.12-slim

ARG TARGETPLATFORM
ARG BUILDPLATFORM
ARG TARGETOS
ARG TARGETARCH

# 작업 디렉토리 설정
WORKDIR /app

# 환경 변수 설정
ENV PYTHONPATH=/app
ENV PYTHONUNBUFFERED=1
ENV PYTHONDONTWRITEBYTECODE=1
ENV PIP_NO_CACHE_DIR=1
ENV PIP_DISABLE_PIP_VERSION_CHECK=1

# 시스템 의존성 설치 (런타임에 필요한 최소한의 패키지)
RUN apt-get update && apt-get install -y \
    curl \
    postgresql-client \
    libpq5 \
    && rm -rf /var/lib/apt/lists/* \
    && apt-get clean

# 빌더 스테이지에서 Python 패키지 복사
COPY --from=builder /usr/local/lib/python3.12/site-packages /usr/local/lib/python3.12/site-packages
COPY --from=builder /usr/local/bin /usr/local/bin

# 프로젝트 코드 복사
COPY backend/ ./backend/

# 로그 및 데이터 디렉토리 생성 (윈도우 권한 문제 방지)
RUN mkdir -p /app/logs /app/data && \
    chmod 755 /app/logs /app/data

# 비root 사용자 생성 (보안 강화)
RUN groupadd -r appuser && useradd -r -g appuser -m -d /home/appuser appuser && \
    mkdir -p /home/appuser/.cache/huggingface && \
    chown -R appuser:appuser /app /home/appuser
USER appuser

# HuggingFace 캐시 디렉토리 설정
ENV HF_HOME=/home/appuser/.cache/huggingface
ENV TRANSFORMERS_CACHE=/home/appuser/.cache/huggingface/transformers

# 포트 노출
EXPOSE 8000

# Health check (윈도우 Docker Desktop에서 더 안정적)
HEALTHCHECK --interval=30s --timeout=10s --start-period=60s --retries=3 \
    CMD curl -f http://localhost:8000/api/llm/health || exit 1

# Django 서버 시작
# 개발 환경에서는 runserver, 프로덕션에서는 gunicorn 사용
CMD ["sh", "-c", "cd /app/backend/services/api/django && python manage.py migrate && if [ \"$ENV\" = \"development\" ]; then python manage.py runserver 0.0.0.0:8000; else gunicorn config.wsgi:application --bind 0.0.0.0:8000 --workers 4; fi"]

